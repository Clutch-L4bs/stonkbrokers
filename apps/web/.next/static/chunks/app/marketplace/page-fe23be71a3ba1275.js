(self.webpackChunk_N_E=self.webpackChunk_N_E||[]).push([[94],{1069:(e,t,a)=>{"use strict";a.d(t,{BI:()=>I,MB:()=>S,MarketplacePanel:()=>T,S8:()=>C,jt:()=>L});var r=a(5155),s=a(2115),n=a(2307),l=a(8245),i=a(9361),c=a(6630),o=a(8590),d=a(9719),m=a(8839),x=a(2933),g=a(3376);function p(e){return e.slice(0,6)+"..."+e.slice(-4)}function f(e){return"".concat(x.$.blockExplorerUrl||"https://explorer.testnet.chain.robinhood.com","/address/").concat(e)}function h(e){return"".concat(x.$.blockExplorerUrl||"https://explorer.testnet.chain.robinhood.com","/tx/").concat(e)}function u(e){let t=e.toLowerCase();return x.$.originalNft&&t===x.$.originalNft.toLowerCase()?"OG":x.$.legacyExpandedNft&&t===x.$.legacyExpandedNft.toLowerCase()?"Expanded (v1)":x.$.expandedNft&&t===x.$.expandedNft.toLowerCase()?"Expanded":p(e)}let b=new Map,y=new Map;function N(e){return e?e.startsWith("ipfs://")?"https://cloudflare-ipfs.com/ipfs/".concat(e.slice(7)):e.startsWith("ar://")?"https://arweave.net/".concat(e.slice(5)):e:e}async function w(e,t){var a,r,s;let n="".concat(e.toLowerCase(),":").concat(t.toString());if(b.has(n))return null!=(a=b.get(n))?a:null;if(y.has(n))return null!=(r=await y.get(n))?r:null;let l=(async()=>{try{let a=await m.R.readContract({address:e,abi:g.hL,functionName:"tokenURI",args:[t]}),r=function(e){if(!e.startsWith("data:application/json"))return null;let t=e.indexOf(",");if(t<0)return null;let a=e.slice(0,t),r=e.slice(t+1);try{if(a.includes(";base64")){let e=atob(r);return JSON.parse(e)}return JSON.parse(decodeURIComponent(r))}catch(e){return null}}(a);if(r&&"string"==typeof(null==r?void 0:r.image)){let e=N(r.image);return b.set(n,e),e}let s=N(a),l=await fetch(s);if(!l.ok)throw Error("tokenURI fetch failed: ".concat(l.status));let i=await l.json().catch(()=>null),c=(null==i?void 0:i.image)||(null==i?void 0:i.image_url)||(null==i?void 0:i.imageUrl);if("string"!=typeof c||!c)return b.set(n,null),null;let o=N(c);return b.set(n,o),o}catch(e){return b.set(n,null),null}finally{y.delete(n)}})();return y.set(n,l),null!=(s=await l)?s:null}function v(e){let{nft:t,tokenId:a,label:n}=e,[l,i]=(0,s.useState)(null);return(0,s.useEffect)(()=>{let e=!1;return w(t,a).then(t=>{e||i(t)}),()=>{e=!0}},[t,a]),(0,r.jsx)("div",{className:"w-12 h-12 flex items-center justify-center bg-lm-black border border-lm-terminal-gray overflow-hidden flex-shrink-0",children:l?(0,r.jsx)("img",{src:l,alt:n,className:"w-full h-full object-cover",loading:"lazy"}):(0,r.jsx)("div",{className:"text-[10px] text-lm-gray lm-mono",children:"NO IMG"})})}function j(){return(0,s.useMemo)(()=>{let e=[];return x.$.originalNft&&e.push(x.$.originalNft),x.$.legacyExpandedNft&&e.push(x.$.legacyExpandedNft),x.$.expandedNft&&e.push(x.$.expandedNft),e},[])}function k(){let{address:e}=(0,d.v)(),t=j(),[a,r]=(0,s.useState)([]),[n,l]=(0,s.useState)(!1);async function i(){if(!e)return void r([]);l(!0);try{let a=[];for(let r of t)try{let t=Number(await m.R.readContract({address:r,abi:g.hL,functionName:"balanceOf",args:[e]})),s=Math.min(t,30);for(let t=0;t<s;t++){let s=await m.R.readContract({address:r,abi:g.hL,functionName:"tokenOfOwnerByIndex",args:[e,BigInt(t)]});a.push({nft:r,tokenId:s,label:"".concat(u(r)," #").concat(s.toString())})}}catch(e){}r(a)}finally{l(!1)}}return(0,s.useEffect)(()=>{i().catch(()=>{})},[e]),{owned:a,refreshOwned:i,loadingOwned:n}}function C(){let{address:e,walletClient:t,requireCorrectChain:a}=(0,d.v)(),i=x.$.marketplace,[c,o]=(0,s.useState)([]),[h,b]=(0,s.useState)(""),[y,N]=(0,s.useState)(!1),[w,j]=(0,s.useState)(1),[k,C]=(0,s.useState)(!1),[S,I]=(0,s.useState)({}),[L,T]=(0,s.useState)({});async function R(){if(!i)return void b("Missing marketplace address.");N(!0),b("");try{let e=[],t=!1;try{let t=Math.max(1,Math.min(10,w)),a=Math.min(500,Math.max(75,75*t+200)),[r,s]=await Promise.all([m.R.readContract({address:i,abi:g.tZ,functionName:"nextListingId"}),m.R.readContract({address:i,abi:g.tZ,functionName:"nextSwapId"})]),n=Number(r>0n?r-1n:0n),l=Number(s>0n?s-1n:0n),c=[];for(let e=0;e<Math.min(a,n);e++)c.push(BigInt(n-e));let o=[];for(let e=0;e<Math.min(a,l);e++)o.push(BigInt(l-e));for(let t=0;t<c.length;t+=25){let a=c.slice(t,t+25);for(let t of(await Promise.all(a.map(async e=>{try{let t=await m.R.readContract({address:i,abi:g.tZ,functionName:"listings",args:[e]});if(!t||0n===t.id)return null;return{kind:"listing",id:e,seller:t.seller,nft:t.nft,tokenId:t.tokenId,price:t.price,active:!!t.active}}catch(e){return null}}))))t&&e.push(t)}for(let t=0;t<o.length;t+=25){let a=o.slice(t,t+25);for(let t of(await Promise.all(a.map(async e=>{try{let t=await m.R.readContract({address:i,abi:g.tZ,functionName:"swaps",args:[e]});if(!t||0n===t.id)return null;return{kind:"swap",id:e,maker:t.maker,offeredNft:t.offeredNft,offeredTokenId:t.offeredTokenId,requestedNft:t.requestedNft,requestedTokenId:t.requestedTokenId,active:!!t.active}}catch(e){return null}}))))t&&e.push(t)}}catch(x){t=!0;let a=await m.R.getBlockNumber(),r=BigInt(Math.max(1,Math.min(10,w))),s=a>50000n*r?a-50000n*r:0n,l=(0,n.$)("event ListingCreated(uint256 indexed listingId,address indexed seller,address indexed nft,uint256 tokenId,uint8 kind,address paymentToken,uint256 price)"),c=(0,n.$)("event SwapCreated(uint256 indexed swapId,address indexed maker,address indexed offeredNft,uint256 offeredTokenId,address requestedNft,uint256 requestedTokenId)"),[o,d]=await Promise.all([m.R.getLogs({address:i,event:l,fromBlock:s,toBlock:a}),m.R.getLogs({address:i,event:c,fromBlock:s,toBlock:a})]);for(let t of[...new Set(o.map(e=>e.args.listingId))].slice(-75))try{let a=await m.R.readContract({address:i,abi:g.tZ,functionName:"listings",args:[t]});if(!a||0n===a.id)continue;e.push({kind:"listing",id:t,seller:a.seller,nft:a.nft,tokenId:a.tokenId,price:a.price,active:!!a.active})}catch(e){}for(let t of[...new Set(d.map(e=>e.args.swapId))].slice(-75))try{let a=await m.R.readContract({address:i,abi:g.tZ,functionName:"swaps",args:[t]});if(!a||0n===a.id)continue;e.push({kind:"swap",id:t,maker:a.maker,offeredNft:a.offeredNft,offeredTokenId:a.offeredTokenId,requestedNft:a.requestedNft,requestedTokenId:a.requestedTokenId,active:!!a.active})}catch(e){}}e.sort((e,t)=>e.id===t.id?0:e.id>t.id?-1:1),o(e),0===e.length?b("No listings or swaps found."):t&&b("Loaded items (fallback: recent log scan).")}catch(e){b(String((null==e?void 0:e.shortMessage)||(null==e?void 0:e.message)||e))}finally{N(!1)}}async function $(r){let s="l-".concat(r.id);if(!e||!t){I(e=>({...e,[s]:"Connect wallet first."})),T(e=>({...e,[s]:"error"}));return}I(e=>({...e,[s]:"Awaiting signature..."})),T(e=>({...e,[s]:"info"}));try{await a();let n=await t.writeContract({address:i,abi:g.tZ,functionName:"buyWithEth",args:[r.id],value:r.price,chain:m.A,account:e});I(e=>({...e,[s]:"Confirming..."})),await m.R.waitForTransactionReceipt({hash:n}),I(e=>({...e,[s]:"Purchased!"})),T(e=>({...e,[s]:"success"})),await R()}catch(e){I(t=>({...t,[s]:String((null==e?void 0:e.shortMessage)||(null==e?void 0:e.message)||e)})),T(e=>({...e,[s]:"error"}))}}async function A(r){let s="s-".concat(r.id);if(!e||!t){I(e=>({...e,[s]:"Connect wallet first."})),T(e=>({...e,[s]:"error"}));return}I(e=>({...e,[s]:"Approving NFT..."})),T(e=>({...e,[s]:"info"}));try{await a();let n=await m.R.readContract({address:r.requestedNft,abi:g.hL,functionName:"getApproved",args:[r.requestedTokenId]}),l=await m.R.readContract({address:r.requestedNft,abi:g.hL,functionName:"isApprovedForAll",args:[e,i]});if((null==n?void 0:n.toLowerCase())!==i.toLowerCase()&&!l){let a=await t.writeContract({address:r.requestedNft,abi:g.hL,functionName:"approve",args:[i,r.requestedTokenId],chain:m.A,account:e});await m.R.waitForTransactionReceipt({hash:a})}I(e=>({...e,[s]:"Accepting swap..."}));let c=await t.writeContract({address:i,abi:g.tZ,functionName:"acceptSwapOffer",args:[r.id],chain:m.A,account:e});I(e=>({...e,[s]:"Confirming..."})),await m.R.waitForTransactionReceipt({hash:c}),I(e=>({...e,[s]:"Swap completed!"})),T(e=>({...e,[s]:"success"})),await R()}catch(e){I(t=>({...t,[s]:String((null==e?void 0:e.shortMessage)||(null==e?void 0:e.message)||e)})),T(e=>({...e,[s]:"error"}))}}(0,s.useEffect)(()=>{R().catch(()=>{})},[w]);let M=k?c:c.filter(e=>e.active),E=M.filter(e=>"listing"===e.kind).length,B=M.filter(e=>"swap"===e.kind).length;return(0,r.jsxs)("div",{className:"space-y-3",children:[(0,r.jsxs)("div",{className:"flex items-center justify-between gap-2 flex-wrap",children:[(0,r.jsx)("div",{className:"flex items-center gap-3",children:(0,r.jsx)("div",{className:"text-lm-terminal-lightgray text-xs",children:y?(0,r.jsx)("span",{className:"animate-pulse",children:"Scanning blocks..."}):(0,r.jsxs)("span",{children:[(0,r.jsx)("span",{className:"text-white font-bold",children:M.length})," items",E>0&&(0,r.jsxs)("span",{className:"text-lm-orange ml-2",children:[E," sales"]}),B>0&&(0,r.jsxs)("span",{className:"text-lm-green ml-2",children:[B," swaps"]})]})})}),(0,r.jsxs)("div",{className:"flex items-center gap-1",children:[(0,r.jsx)("button",{type:"button",onClick:()=>C(!k),className:"text-[10px] px-2 py-1 border transition-colors ".concat(k?"border-lm-orange text-lm-orange bg-lm-orange/5":"border-lm-terminal-gray text-lm-gray hover:border-lm-gray"),children:k?"Show All":"Active Only"}),(0,r.jsx)("button",{type:"button",onClick:()=>j(1),className:"text-[10px] px-2 py-1 border transition-colors ".concat(1===w?"border-lm-orange text-lm-orange":"border-lm-terminal-gray text-lm-gray hover:border-lm-gray"),children:"Latest"}),(0,r.jsx)("button",{type:"button",onClick:()=>j(e=>Math.min(10,e+1)),className:"text-[10px] px-2 py-1 border border-lm-terminal-gray text-lm-gray hover:border-lm-gray transition-colors",children:"Older"}),(0,r.jsx)("button",{type:"button",onClick:()=>R(),disabled:y,className:"text-[10px] px-2 py-1 border border-lm-orange text-lm-orange hover:bg-lm-orange/5 transition-colors font-bold disabled:opacity-40 disabled:pointer-events-none",children:y?"...":"Refresh"})]})]}),h&&(0,r.jsx)("div",{className:"text-lm-red text-xs p-2 border border-lm-red/30 bg-lm-black",children:h}),0!==M.length||y?(0,r.jsx)("div",{className:"space-y-2",children:M.map(t=>{let a="".concat(t.kind[0],"-").concat(t.id),s=S[a],n=L[a]||"info",i="success"===n?"text-lm-green":"error"===n?"text-lm-red":"text-lm-gray";if("listing"===t.kind){let n="".concat(u(t.nft)," #").concat(t.tokenId.toString());return(0,r.jsxs)("div",{className:"bg-lm-terminal-darkgray border transition-colors p-3 space-y-2 lm-card-hover ".concat(t.active?"border-lm-orange/20":"border-lm-terminal-gray opacity-60"),children:[(0,r.jsxs)("div",{className:"flex items-center justify-between flex-wrap gap-2",children:[(0,r.jsxs)("div",{className:"flex items-center gap-2 min-w-0",children:[t.active?(0,r.jsx)(v,{nft:t.nft,tokenId:t.tokenId,label:n}):null,(0,r.jsx)("span",{className:"lm-badge lm-badge-orange",children:"SALE"}),(0,r.jsx)("span",{className:"text-white font-bold text-sm truncate",children:n})]}),(0,r.jsxs)("div",{className:"flex items-center gap-2",children:[(0,r.jsxs)("span",{className:"text-white font-bold lm-mono text-sm",children:[(0,l.c)(t.price)," ETH"]}),(0,r.jsx)("span",{className:"lm-badge ".concat(t.active?"lm-badge-green":"lm-badge-gray"),children:t.active?"ACTIVE":"SOLD"})]})]}),(0,r.jsxs)("div",{className:"flex items-center gap-4 text-[10px]",children:[(0,r.jsxs)("div",{children:[(0,r.jsx)("span",{className:"text-lm-terminal-lightgray",children:"Seller: "}),(0,r.jsx)("a",{href:f(t.seller),target:"_blank",rel:"noreferrer",className:"text-lm-orange hover:underline lm-mono",children:p(t.seller)})]}),(0,r.jsxs)("div",{children:[(0,r.jsx)("span",{className:"text-lm-terminal-lightgray",children:"Collection: "}),(0,r.jsx)("span",{className:"text-white",children:u(t.nft)})]})]}),(0,r.jsxs)("div",{className:"flex items-center gap-2 flex-wrap",children:[t.active&&e&&e.toLowerCase()!==t.seller.toLowerCase()&&(0,r.jsx)("button",{type:"button",onClick:()=>$(t),disabled:"info"===L["l-".concat(t.id)],className:"text-xs px-4 py-1.5 bg-lm-orange text-black font-bold hover:bg-lm-orange/80 transition-colors disabled:opacity-40 disabled:pointer-events-none",children:"info"===L["l-".concat(t.id)]?"Processing...":"Buy for ".concat((0,l.c)(t.price)," ETH")}),t.active&&e&&e.toLowerCase()===t.seller.toLowerCase()&&(0,r.jsx)("span",{className:"text-[10px] text-lm-terminal-lightgray",children:"Your listing — manage in My Activity"}),!e&&t.active&&(0,r.jsx)("span",{className:"text-[10px] text-lm-terminal-lightgray",children:"Connect wallet to buy"}),s&&(0,r.jsx)("span",{className:"text-[10px] ".concat(i),children:s})]})]},a)}return(0,r.jsxs)("div",{className:"bg-lm-terminal-darkgray border transition-colors p-3 space-y-2 lm-card-hover ".concat(t.active?"border-lm-green/20":"border-lm-terminal-gray opacity-60"),children:[(0,r.jsxs)("div",{className:"flex items-center justify-between flex-wrap gap-1",children:[(0,r.jsxs)("div",{className:"flex items-center gap-2",children:[(0,r.jsx)("span",{className:"lm-badge lm-badge-green",children:"SWAP"}),(0,r.jsxs)("span",{className:"text-white font-bold text-sm",children:[u(t.offeredNft)," #",t.offeredTokenId.toString()]}),(0,r.jsx)("span",{className:"text-lm-orange text-xs font-bold",children:"→"}),(0,r.jsxs)("span",{className:"text-white font-bold text-sm",children:[u(t.requestedNft)," #",t.requestedTokenId.toString()]})]}),(0,r.jsx)("span",{className:"lm-badge ".concat(t.active?"lm-badge-green":"lm-badge-gray"),children:t.active?"OPEN":"FILLED"})]}),(0,r.jsxs)("div",{className:"flex items-center gap-4 text-[10px]",children:[(0,r.jsxs)("div",{children:[(0,r.jsx)("span",{className:"text-lm-terminal-lightgray",children:"Maker: "}),(0,r.jsx)("a",{href:f(t.maker),target:"_blank",rel:"noreferrer",className:"text-lm-orange hover:underline lm-mono",children:p(t.maker)})]}),(0,r.jsxs)("div",{children:[(0,r.jsx)("span",{className:"text-lm-terminal-lightgray",children:"Wants: "}),(0,r.jsxs)("span",{className:"text-white font-bold",children:[u(t.requestedNft)," #",t.requestedTokenId.toString()]})]})]}),(0,r.jsxs)("div",{className:"flex items-center gap-2 flex-wrap",children:[t.active&&e&&e.toLowerCase()!==t.maker.toLowerCase()&&(0,r.jsx)("button",{type:"button",onClick:()=>A(t),disabled:"info"===L["s-".concat(t.id)],className:"text-xs px-4 py-1.5 bg-lm-green/90 text-black font-bold hover:bg-lm-green transition-colors disabled:opacity-40 disabled:pointer-events-none",children:"info"===L["s-".concat(t.id)]?"Processing...":"Accept Swap"}),t.active&&e&&e.toLowerCase()===t.maker.toLowerCase()&&(0,r.jsx)("span",{className:"text-[10px] text-lm-terminal-lightgray",children:"Your offer — manage in My Activity"}),!e&&t.active&&(0,r.jsx)("span",{className:"text-[10px] text-lm-terminal-lightgray",children:"Connect wallet to accept"}),s&&(0,r.jsx)("span",{className:"text-[10px] ".concat(i),children:s})]})]},a)})}):(0,r.jsxs)("div",{className:"text-center py-10 space-y-2",children:[(0,r.jsx)("div",{className:"text-lm-terminal-lightgray text-lg",children:"No Items Found"}),(0,r.jsx)("div",{className:"text-lm-terminal-lightgray text-xs opacity-60",children:"List a broker in the Sell tab or create a swap offer."})]})]})}function S(){let{address:e,walletClient:t,requireCorrectChain:a}=(0,d.v)(),n=x.$.marketplace,l=j(),{owned:p,refreshOwned:f}=k(),[b,y]=(0,s.useState)(x.$.expandedNft||x.$.originalNft||""),[N,w]=(0,s.useState)(""),[v,C]=(0,s.useState)(""),[S,I]=(0,s.useState)(""),[L,T]=(0,s.useState)("info"),[R,$]=(0,s.useState)(!1),[A,M]=(0,s.useState)(""),E=(0,s.useMemo)(()=>p.filter(e=>e.nft.toLowerCase()===(null==b?void 0:b.toLowerCase())),[p,b]);async function B(){if(!e||!t){I("Connect wallet."),T("error");return}if(!N){I("Select a broker to list."),T("error");return}$(!0),M("");try{I("Preparing listing..."),T("info"),await a();let r=BigInt(N),s=(0,i.g)(v||"0");if(s<=0n)throw Error("Set a price > 0");let l=await m.R.readContract({address:b,abi:g.hL,functionName:"getApproved",args:[r]}),c=await m.R.readContract({address:b,abi:g.hL,functionName:"isApprovedForAll",args:[e,n]});if((null==l?void 0:l.toLowerCase())!==n.toLowerCase()&&!c){I("Approving marketplace...");let a=await t.writeContract({address:b,abi:g.hL,functionName:"approve",args:[n,r],chain:m.A,account:e});await m.R.waitForTransactionReceipt({hash:a})}I("Awaiting signature...");let o=await t.writeContract({address:n,abi:g.tZ,functionName:"createEthListing",args:[b,r,s],chain:m.A,account:e});M(o),I("Confirming..."),await m.R.waitForTransactionReceipt({hash:o}),I("Listing created!"),T("success"),w(""),C(""),await f()}catch(e){I(String((null==e?void 0:e.shortMessage)||(null==e?void 0:e.message)||e)),T("error")}finally{$(!1)}}return(0,r.jsxs)("div",{className:"space-y-4",children:[(0,r.jsxs)("div",{className:"bg-lm-terminal-darkgray border border-lm-terminal-gray p-4 space-y-3",children:[(0,r.jsx)("div",{className:"text-lm-terminal-lightgray text-[10px] lm-upper font-bold tracking-wider",children:"List Broker for Sale"}),(0,r.jsx)("div",{className:"text-lm-terminal-lightgray text-xs",children:"Your broker will be escrowed in the marketplace contract until sold or you cancel."}),(0,r.jsxs)("div",{className:"space-y-1",children:[(0,r.jsx)("div",{className:"text-lm-terminal-lightgray text-xs",children:"Collection"}),(0,r.jsx)("div",{className:"flex gap-1 flex-wrap",children:l.map(e=>(0,r.jsx)("button",{type:"button",onClick:()=>{y(e),w("")},className:"text-xs px-2 py-1 border transition-colors ".concat((null==b?void 0:b.toLowerCase())===e.toLowerCase()?"border-lm-orange text-lm-orange bg-lm-orange/5":"border-lm-terminal-gray text-lm-gray hover:border-lm-gray"),children:u(e)},e))})]}),(0,r.jsxs)("div",{className:"space-y-1",children:[(0,r.jsx)("div",{className:"text-lm-terminal-lightgray text-xs",children:"Your Broker"}),0===E.length?(0,r.jsx)("div",{className:"text-lm-gray text-xs py-2",children:e?"No brokers from this collection.":"Connect wallet to see your brokers."}):(0,r.jsx)("div",{className:"flex gap-1 flex-wrap",children:E.map(e=>(0,r.jsxs)("button",{type:"button",onClick:()=>w(e.tokenId.toString()),className:"text-xs px-2 py-1 border transition-colors ".concat(N===e.tokenId.toString()?"border-lm-orange text-lm-orange bg-lm-orange/5":"border-lm-terminal-gray text-lm-gray hover:border-lm-gray"),children:["#",e.tokenId.toString()]},"".concat(e.nft,":").concat(e.tokenId)))})]}),(0,r.jsxs)("div",{className:"space-y-1",children:[(0,r.jsx)("div",{className:"text-lm-terminal-lightgray text-xs",children:"Price (ETH)"}),(0,r.jsx)(o.p,{value:v,onValueChange:C,placeholder:"0.05"})]}),(0,r.jsx)(c.$,{onClick:B,loading:R,disabled:R||!N,variant:"primary",size:"lg",className:"w-full",children:R?"Creating Listing...":e?"Create Listing":"Connect Wallet"})]}),S&&(0,r.jsxs)("div",{className:"text-xs p-2.5 border bg-lm-black flex items-center justify-between gap-2 ".concat("success"===L?"text-lm-green":"error"===L?"text-lm-red":"text-lm-gray"," ").concat("success"===L?"border-lm-green/20":"error"===L?"border-lm-red/20":"border-lm-terminal-gray"),children:[(0,r.jsxs)("div",{className:"flex items-center gap-2 min-w-0",children:["info"===L&&(0,r.jsx)("span",{className:"lm-spinner flex-shrink-0",style:{width:12,height:12,borderWidth:1.5}}),"success"===L&&(0,r.jsx)("span",{className:"lm-dot lm-dot-green flex-shrink-0"}),"error"===L&&(0,r.jsx)("span",{className:"lm-dot lm-dot-red flex-shrink-0"}),(0,r.jsx)("span",{className:"truncate",children:S})]}),A&&(0,r.jsx)("a",{href:h(A),target:"_blank",rel:"noreferrer",className:"text-lm-orange hover:underline flex-shrink-0",children:"View Tx →"})]})]})}function I(){let{address:e,walletClient:t,requireCorrectChain:a}=(0,d.v)(),n=x.$.marketplace,l=j(),{owned:i,refreshOwned:p}=k(),[f,b]=(0,s.useState)(x.$.expandedNft||x.$.originalNft||""),[y,N]=(0,s.useState)(""),[w,v]=(0,s.useState)(x.$.expandedNft||x.$.originalNft||""),[C,S]=(0,s.useState)(""),[I,L]=(0,s.useState)(""),[T,R]=(0,s.useState)("info"),[$,A]=(0,s.useState)(!1),[M,E]=(0,s.useState)(""),B=(0,s.useMemo)(()=>i.filter(e=>e.nft.toLowerCase()===(null==f?void 0:f.toLowerCase())),[i,f]);async function q(){if(!e||!t){L("Connect wallet."),R("error");return}if(!y){L("Select your broker to offer."),R("error");return}if(!C){L("Enter the token ID you want."),R("error");return}A(!0),E("");try{L("Preparing swap..."),R("info"),await a();let r=BigInt(y),s=BigInt(C),l=await m.R.readContract({address:f,abi:g.hL,functionName:"getApproved",args:[r]}),i=await m.R.readContract({address:f,abi:g.hL,functionName:"isApprovedForAll",args:[e,n]});if((null==l?void 0:l.toLowerCase())!==n.toLowerCase()&&!i){L("Approving marketplace...");let a=await t.writeContract({address:f,abi:g.hL,functionName:"approve",args:[n,r],chain:m.A,account:e});await m.R.waitForTransactionReceipt({hash:a})}L("Awaiting signature...");let c=await t.writeContract({address:n,abi:g.tZ,functionName:"createSwapOffer",args:[f,r,w,s],chain:m.A,account:e});E(c),L("Confirming..."),await m.R.waitForTransactionReceipt({hash:c}),L("Swap offer created!"),R("success"),N(""),S(""),await p()}catch(e){L(String((null==e?void 0:e.shortMessage)||(null==e?void 0:e.message)||e)),R("error")}finally{A(!1)}}return(0,r.jsxs)("div",{className:"space-y-4",children:[(0,r.jsxs)("div",{className:"bg-lm-terminal-darkgray border border-lm-terminal-gray p-4 space-y-3",children:[(0,r.jsx)("div",{className:"text-lm-terminal-lightgray text-[10px] lm-upper font-bold tracking-wider",children:"Create Swap Offer"}),(0,r.jsx)("div",{className:"text-lm-terminal-lightgray text-xs",children:"Trade your broker for another. Your NFT is escrowed until the swap is accepted or you cancel."}),(0,r.jsxs)("div",{className:"space-y-1",children:[(0,r.jsx)("div",{className:"text-lm-orange text-xs font-bold",children:"YOU OFFER"}),(0,r.jsx)("div",{className:"flex gap-1 flex-wrap",children:l.map(e=>(0,r.jsx)("button",{type:"button",onClick:()=>{b(e),N("")},className:"text-xs px-2 py-1 border transition-colors ".concat((null==f?void 0:f.toLowerCase())===e.toLowerCase()?"border-lm-orange text-lm-orange bg-lm-orange/5":"border-lm-terminal-gray text-lm-gray hover:border-lm-gray"),children:u(e)},e))}),0===B.length?(0,r.jsx)("div",{className:"text-lm-gray text-xs py-1",children:e?"No brokers from this collection.":"Connect wallet."}):(0,r.jsx)("div",{className:"flex gap-1 flex-wrap",children:B.map(e=>(0,r.jsxs)("button",{type:"button",onClick:()=>N(e.tokenId.toString()),className:"text-xs px-2 py-1 border transition-colors ".concat(y===e.tokenId.toString()?"border-lm-orange text-lm-orange bg-lm-orange/5":"border-lm-terminal-gray text-lm-gray hover:border-lm-gray"),children:["#",e.tokenId.toString()]},"".concat(e.nft,":").concat(e.tokenId)))})]}),(0,r.jsx)("div",{className:"text-center text-lm-gray text-xs",children:"↓ for ↓"}),(0,r.jsxs)("div",{className:"space-y-1",children:[(0,r.jsx)("div",{className:"text-lm-green text-xs font-bold",children:"YOU WANT"}),(0,r.jsx)("div",{className:"flex gap-1 flex-wrap",children:l.map(e=>(0,r.jsx)("button",{type:"button",onClick:()=>v(e),className:"text-xs px-2 py-1 border transition-colors ".concat((null==w?void 0:w.toLowerCase())===e.toLowerCase()?"border-lm-green text-lm-green bg-lm-green/5":"border-lm-terminal-gray text-lm-gray hover:border-lm-gray"),children:u(e)},e))}),(0,r.jsxs)("div",{className:"space-y-1",children:[(0,r.jsx)("div",{className:"text-lm-terminal-lightgray text-xs",children:"Token ID"}),(0,r.jsx)(o.p,{value:C,onValueChange:S,placeholder:"e.g. 445"})]})]}),(0,r.jsx)(c.$,{onClick:q,loading:$,disabled:$||!y||!C,variant:"primary",size:"lg",className:"w-full",children:$?"Creating Swap...":e?"Create Swap Offer":"Connect Wallet"})]}),I&&(0,r.jsxs)("div",{className:"text-xs p-2.5 border bg-lm-black flex items-center justify-between gap-2 ".concat("success"===T?"text-lm-green":"error"===T?"text-lm-red":"text-lm-gray"," ").concat("success"===T?"border-lm-green/20":"error"===T?"border-lm-red/20":"border-lm-terminal-gray"),children:[(0,r.jsxs)("div",{className:"flex items-center gap-2 min-w-0",children:["info"===T&&(0,r.jsx)("span",{className:"lm-spinner flex-shrink-0",style:{width:12,height:12,borderWidth:1.5}}),"success"===T&&(0,r.jsx)("span",{className:"lm-dot lm-dot-green flex-shrink-0"}),"error"===T&&(0,r.jsx)("span",{className:"lm-dot lm-dot-red flex-shrink-0"}),(0,r.jsx)("span",{className:"truncate",children:I})]}),M&&(0,r.jsx)("a",{href:h(M),target:"_blank",rel:"noreferrer",className:"text-lm-orange hover:underline flex-shrink-0",children:"View Tx →"})]})]})}function L(){let{address:e,walletClient:t,requireCorrectChain:a}=(0,d.v)(),i=x.$.marketplace,[c,o]=(0,s.useState)([]),[p,f]=(0,s.useState)([]),[h,b]=(0,s.useState)(""),[y,N]=(0,s.useState)(!1),[w,v]=(0,s.useState)({}),[j,k]=(0,s.useState)({});async function C(){if(!e||!i){o([]),f([]);return}N(!0),b("");try{let t=await m.R.getBlockNumber(),a=t>50000n?t-50000n:0n,[r,s]=await Promise.all([m.R.getLogs({address:i,event:(0,n.$)("event ListingCreated(uint256 indexed listingId,address indexed seller,address indexed nft,uint256 tokenId,uint8 kind,address paymentToken,uint256 price)"),args:{seller:e},fromBlock:a,toBlock:t}),m.R.getLogs({address:i,event:(0,n.$)("event SwapCreated(uint256 indexed swapId,address indexed maker,address indexed offeredNft,uint256 offeredTokenId,address requestedNft,uint256 requestedTokenId)"),args:{maker:e},fromBlock:a,toBlock:t})]),l=[];for(let e of[...new Set(r.map(e=>e.args.listingId))].reverse().slice(0,30))try{let t=await m.R.readContract({address:i,abi:g.tZ,functionName:"listings",args:[e]});l.push({kind:"listing",id:e,seller:t.seller,nft:t.nft,tokenId:t.tokenId,price:t.price,active:!!t.active})}catch(e){}let c=[];for(let e of[...new Set(s.map(e=>e.args.swapId))].reverse().slice(0,30))try{let t=await m.R.readContract({address:i,abi:g.tZ,functionName:"swaps",args:[e]});c.push({kind:"swap",id:e,maker:t.maker,offeredNft:t.offeredNft,offeredTokenId:t.offeredTokenId,requestedNft:t.requestedNft,requestedTokenId:t.requestedTokenId,active:!!t.active})}catch(e){}o(l),f(c),0===l.length&&0===c.length&&b("No activity found in recent blocks.")}catch(e){b(String((null==e?void 0:e.shortMessage)||(null==e?void 0:e.message)||e))}finally{N(!1)}}async function S(r){if(!e||!t)return;let s="cl-".concat(r);v(e=>({...e,[s]:"Cancelling..."})),k(e=>({...e,[s]:"info"}));try{await a();let n=await t.writeContract({address:i,abi:g.tZ,functionName:"cancelListing",args:[r],chain:m.A,account:e});v(e=>({...e,[s]:"Confirming..."})),await m.R.waitForTransactionReceipt({hash:n}),v(e=>({...e,[s]:"Cancelled!"})),k(e=>({...e,[s]:"success"})),await C()}catch(e){v(t=>({...t,[s]:String((null==e?void 0:e.shortMessage)||(null==e?void 0:e.message)||e)})),k(e=>({...e,[s]:"error"}))}}async function I(r){if(!e||!t)return;let s="cs-".concat(r);v(e=>({...e,[s]:"Cancelling..."})),k(e=>({...e,[s]:"info"}));try{await a();let n=await t.writeContract({address:i,abi:g.tZ,functionName:"cancelSwapOffer",args:[r],chain:m.A,account:e});v(e=>({...e,[s]:"Confirming..."})),await m.R.waitForTransactionReceipt({hash:n}),v(e=>({...e,[s]:"Cancelled!"})),k(e=>({...e,[s]:"success"})),await C()}catch(e){v(t=>({...t,[s]:String((null==e?void 0:e.shortMessage)||(null==e?void 0:e.message)||e)})),k(e=>({...e,[s]:"error"}))}}return((0,s.useEffect)(()=>{C().catch(()=>{})},[e]),e)?(0,r.jsxs)("div",{className:"space-y-4",children:[(0,r.jsxs)("div",{className:"flex items-center justify-between gap-2",children:[(0,r.jsxs)("div",{className:"flex items-center gap-3 text-xs",children:[c.length>0&&(0,r.jsxs)("span",{className:"text-lm-orange font-bold",children:[c.length," listing",1!==c.length?"s":""]}),p.length>0&&(0,r.jsxs)("span",{className:"text-lm-green font-bold",children:[p.length," swap",1!==p.length?"s":""]}),0===c.length&&0===p.length&&!y&&(0,r.jsx)("span",{className:"text-lm-terminal-lightgray",children:"No activity"})]}),(0,r.jsx)("button",{type:"button",onClick:()=>C(),disabled:y,className:"text-[10px] px-2 py-1 border border-lm-orange text-lm-orange hover:bg-lm-orange/5 transition-colors font-bold",children:y?"Loading...":"Refresh"})]}),h&&0===c.length&&0===p.length&&(0,r.jsxs)("div",{className:"text-center py-8 space-y-2",children:[(0,r.jsx)("div",{className:"text-lm-terminal-lightgray text-lg",children:"No Activity Yet"}),(0,r.jsx)("div",{className:"text-lm-terminal-lightgray text-xs opacity-60",children:h})]}),c.length>0&&(0,r.jsxs)("div",{className:"space-y-2",children:[(0,r.jsx)("div",{className:"text-lm-terminal-lightgray text-[10px] lm-upper font-bold tracking-wider",children:"Your Listings"}),c.map(e=>{let t="cl-".concat(e.id),a=w[t],s=j[t]||"info";return(0,r.jsxs)("div",{className:"bg-lm-terminal-darkgray border p-3 flex items-center justify-between gap-3 flex-wrap ".concat(e.active?"border-lm-orange/20":"border-lm-terminal-gray opacity-60"),children:[(0,r.jsxs)("div",{className:"space-y-0.5",children:[(0,r.jsxs)("div",{className:"flex items-center gap-2",children:[(0,r.jsxs)("span",{className:"text-white font-bold text-sm",children:[u(e.nft)," #",e.tokenId.toString()]}),(0,r.jsx)("span",{className:"lm-badge ".concat(e.active?"lm-badge-green":"lm-badge-gray"),children:e.active?"ACTIVE":"SOLD"})]}),(0,r.jsxs)("div",{className:"text-white text-xs lm-mono font-bold",children:[(0,l.c)(e.price)," ETH"]})]}),(0,r.jsxs)("div",{className:"flex items-center gap-2",children:[e.active&&(0,r.jsx)("button",{type:"button",onClick:()=>S(e.id),disabled:"info"===j["cl-".concat(e.id)],className:"text-xs px-3 py-1.5 bg-lm-red/10 text-lm-red border border-lm-red/30 hover:bg-lm-red/20 transition-colors disabled:opacity-40 disabled:pointer-events-none",children:"info"===j["cl-".concat(e.id)]?"Cancelling...":"Cancel Listing"}),a&&(0,r.jsx)("span",{className:"text-[10px] ".concat("success"===s?"text-lm-green":"error"===s?"text-lm-red":"text-lm-gray"),children:a})]})]},t)})]}),p.length>0&&(0,r.jsxs)("div",{className:"space-y-2",children:[(0,r.jsx)("div",{className:"text-lm-terminal-lightgray text-[10px] lm-upper font-bold tracking-wider",children:"Your Swap Offers"}),p.map(e=>{let t="cs-".concat(e.id),a=w[t],s=j[t]||"info";return(0,r.jsxs)("div",{className:"bg-lm-terminal-darkgray border p-3 flex items-center justify-between gap-3 flex-wrap ".concat(e.active?"border-lm-green/20":"border-lm-terminal-gray opacity-60"),children:[(0,r.jsx)("div",{className:"space-y-0.5",children:(0,r.jsxs)("div",{className:"flex items-center gap-2",children:[(0,r.jsxs)("span",{className:"text-white font-bold text-sm",children:[u(e.offeredNft)," #",e.offeredTokenId.toString()]}),(0,r.jsx)("span",{className:"text-lm-orange text-xs font-bold",children:"→"}),(0,r.jsxs)("span",{className:"text-white font-bold text-sm",children:[u(e.requestedNft)," #",e.requestedTokenId.toString()]}),(0,r.jsx)("span",{className:"lm-badge ".concat(e.active?"lm-badge-green":"lm-badge-gray"),children:e.active?"OPEN":"FILLED"})]})}),(0,r.jsxs)("div",{className:"flex items-center gap-2",children:[e.active&&(0,r.jsx)("button",{type:"button",onClick:()=>I(e.id),disabled:"info"===j["cs-".concat(e.id)],className:"text-xs px-3 py-1.5 bg-lm-red/10 text-lm-red border border-lm-red/30 hover:bg-lm-red/20 transition-colors disabled:opacity-40 disabled:pointer-events-none",children:"info"===j["cs-".concat(e.id)]?"Cancelling...":"Cancel Swap"}),a&&(0,r.jsx)("span",{className:"text-[10px] ".concat("success"===s?"text-lm-green":"error"===s?"text-lm-red":"text-lm-gray"),children:a})]})]},t)})]})]}):(0,r.jsxs)("div",{className:"text-center py-10 space-y-2",children:[(0,r.jsx)("div",{className:"text-lm-terminal-lightgray text-lg",children:"No Wallet Connected"}),(0,r.jsx)("div",{className:"text-lm-terminal-lightgray text-xs opacity-60",children:"Connect your wallet to view your marketplace activity."})]})}function T(){return(0,r.jsx)(C,{})}},4433:(e,t,a)=>{"use strict";a.d(t,{MarketplaceBootstrap:()=>o});var r=a(5155),s=a(2115),n=a(6594),l=a(8070),i=a(1069),c=a(8604);function o(e){let{MarketplacePanel:t}=e,a=(0,s.useMemo)(()=>[{id:"feed",label:"Browse",hint:"Active listings + swap offers"},{id:"list",label:"Sell",hint:"List broker for ETH"},{id:"swap",label:"Swap",hint:"Trade broker for broker"},{id:"activity",label:"My Activity",hint:"Manage your listings + swaps"}],[]),[o,d]=(0,s.useState)("feed"),m=(0,s.useCallback)(e=>{if("buy_listing"===e.type||"accept_swap"===e.type)d("feed");else if("list_nft"===e.type)d("list");else if("create_swap_offer"===e.type)d("swap");else if("cancel_listing"===e.type||"cancel_swap"===e.type)d("activity");else if("switch_tab"===e.type){let t={browse:"feed",sell:"list",swap:"swap",activity:"activity"};t[e.tab]&&d(t[e.tab])}},[]);return(0,r.jsxs)("div",{className:"space-y-4",children:[(0,r.jsx)(c.jc,{context:"marketplace",onIntent:m,placeholder:"list broker #10 for 0.5 ETH \xb7 buy listing #3 \xb7 swap broker #10 for #20 \xb7 help"}),(0,r.jsxs)(n.Z,{title:"Marketplace",hint:"On-chain escrow marketplace. NFTs are secured in the contract until sold, swapped, or cancelled.",right:(0,r.jsx)(l.Z,{tabs:a,active:o,onChange:d}),children:["feed"===o?(0,r.jsx)(i.S8,{}):null,"list"===o?(0,r.jsx)(i.MB,{}):null,"swap"===o?(0,r.jsx)(i.BI,{}):null,"activity"===o?(0,r.jsx)(i.jt,{}):null]})]})}},5028:(e,t,a)=>{"use strict";a.d(t,{X:()=>n});var r=a(6314);class s extends r.C{constructor({value:e}){super(`Number \`${e}\` is not a valid decimal number.`,{name:"InvalidDecimalNumberError"})}}function n(e,t){if(!/^(-?)([0-9]*)\.?([0-9]*)$/.test(e))throw new s({value:e});let[a,r="0"]=e.split("."),n=a.startsWith("-");if(n&&(a=a.slice(1)),r=r.replace(/(0+)$/,""),0===t)1===Math.round(Number(`.${r}`))&&(a=`${BigInt(a)+1n}`),r="";else if(r.length>t){let[e,s,n]=[r.slice(0,t-1),r.slice(t-1,t),r.slice(t)],l=Math.round(Number(`${s}.${n}`));(r=l>9?`${BigInt(e)+BigInt(1)}0`.padStart(e.length+1,"0"):`${e}${l}`).length>t&&(r=r.slice(1),a=`${BigInt(a)+1n}`),r=r.slice(0,t)}else r=r.padEnd(t,"0");return BigInt(`${n?"-":""}${a}${r}`)}},6065:(e,t,a)=>{Promise.resolve().then(a.bind(a,4433)),Promise.resolve().then(a.bind(a,1069))},9361:(e,t,a)=>{"use strict";a.d(t,{g:()=>n});var r=a(2023),s=a(5028);function n(e,t="wei"){return(0,s.X)(e,r.eL[t])}}},e=>{e.O(0,[462,889,653,799,441,255,358],()=>e(e.s=6065)),_N_E=e.O()}]);